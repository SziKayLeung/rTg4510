---
title: "IsoSeq Summary Testing"
author: Szi Kay Leung
date: "`r Sys.Date()`"
knit: (function(inputFile, encoding) { 
      rmarkdown::render(inputFile,
                        encoding=encoding, 
                        output_file=paste0("/gpfs/mrc0/projects/Research_Project-MRC148213/sl693/WholeTranscriptome/Testing/Rmarkdowns",
                        '/IsoSeq_Summary_Testing.html')) })
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE) #,fig.width=14, fig.height= 7)
#rmarkdown::render("/gpfs/ts0/home/sl693") 

suppressMessages(library(ggplot2))
suppressMessages(library(dplyr))
suppressMessages(library(stringr)) 
suppressMessages(library(tidyr))
suppressMessages(library(scales))
suppressMessages(library(rjson))
suppressMessages(library(magrittr))
suppressMessages(library(tibble))
suppressMessages(library(reshape))
suppressMessages(library(plyr))


#font_import()
```


```{r input}
# theme etc 
source("/gpfs/ts0/home/sl693/Scripts/IsoSeq3_Tg4510/Isoseq3/Isoseq3_QC/Rmarkdown_Input.R")

# Input Directory Paths
CCS_input_dir <- "/gpfs/mrc0/projects/Research_Project-MRC148213/sl693/WholeTranscriptome/Testing/CCS"
LiMA_input_dir <- "/gpfs/mrc0/projects/Research_Project-MRC148213/sl693/WholeTranscriptome/Testing/LIMA"
ISOSEQ_input_dir <- "/gpfs/mrc0/projects/Research_Project-MRC148213/sl693/WholeTranscriptome/Testing/REFINE"

# CCS, LIMA summary 
CCS <- read.csv(paste0(CCS_input_dir, "/Testing_CCS_output.csv"), header = T)
LIMA <- read.csv(paste0(LiMA_input_dir, "/Testing_LIMA_summary.csv"), header = T)

# REFINE summary input 
REFINE_json_list <- list.files(paste0(ISOSEQ_input_dir), pattern = "flnc.filter_summary.json", full.names = T)
REFINE_list <- lapply(REFINE_json_list , function(x) as.data.frame(fromJSON(file = x)))
names(REFINE_list) <- list.files(paste0(ISOSEQ_input_dir), pattern = "flnc.filter_summary.json")
for(i in 1:length(names(REFINE_list))){
  REFINE_list[[i]]$Sample <- names(REFINE_list)[[i]]
}


```
```{r functions}
# input_multiple_csv 
input_multiple_csv <- function(input_dir_path, str_pattern){
  dat_files <- list.files(paste0(input_dir_path), pattern = str_pattern, full.names = T)
  dat <- lapply(dat_files, function(x) read.csv(x))
  names(dat) <- list.files(paste0(input_dir_path), pattern = str_pattern)
  
  for(i in 1:length(names(dat))){
    dat[[i]]$Sample <- paste(word(names(dat)[[i]], c(1), sep = fixed ('.')))
  }
  
  return(dat)
}

# plots 
plot_boxplot <- function(dat, x_var, y_var, xlabel, ylabel, group_var){
  
  x_var <- rlang::sym(quo_name(enquo(x_var)))
  y_var <- rlang::sym(quo_name(enquo(y_var)))
  group_var <- rlang::sym(quo_name(enquo(group_var)))
  
  p <- ggplot(dat, aes(x = reorder( !! x_var, - !!y_var), y = !!y_var)) + 
    geom_boxplot() +
    geom_jitter(aes(color = !!group_var), shape=16, position=position_jitter(0.2)) +
    theme_bw() +
    #theme(axis.text.x = element_text(angle = 45, hjust = 1)) + 
    scale_y_continuous(labels = comma) + 
    labs(x = xlabel, y = ylabel) +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_text(margin = margin(t = 0, r = 15 , b = 0, l = 0))) 
  
  
  return(p)
  
}

plot_line <- function(dat, x_var, y_var, xlabel, ylabel, group_var){
  
  x_var <- rlang::sym(quo_name(enquo(x_var)))
  y_var <- rlang::sym(quo_name(enquo(y_var)))
  group_var <- rlang::sym(quo_name(enquo(group_var)))
  
  p <- ggplot(dat, aes(x = reorder( !! x_var, - !!y_var), y = !!y_var, group = !! group_var)) + 
    geom_line(aes(linetype=!!group_var, color = !! group_var)) +
    geom_point(shape=20) +
    theme_bw() +
    #scale_y_continuous(labels = comma) + 
    labs(x = xlabel, y = ylabel) +
    theme(#axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_text(margin = margin(t = 0, r = 15 , b = 0, l = 0))) 
  
  return(p)
  
}

plot_line_no_reorder <- function(dat, x_var, y_var, xlabel, ylabel, group_var){
  
  x_var <- rlang::sym(quo_name(enquo(x_var)))
  y_var <- rlang::sym(quo_name(enquo(y_var)))
  group_var <- rlang::sym(quo_name(enquo(group_var)))
  
  p <- ggplot(dat, aes(x = !! x_var, y = !!y_var, group = !! group_var)) + 
    geom_line(aes(linetype=!!group_var, color = !! group_var)) +
    geom_point(shape=20) +
    theme_bw() +
    #scale_y_continuous(labels = comma) + 
    labs(x = xlabel, y = ylabel) +
    theme(#axis.text.x = element_text(angle = 45, hjust = 1),
          axis.title.y = element_text(margin = margin(t = 0, r = 15 , b = 0, l = 0))) 
  
  return(p)
  
}

```
```{r data_wrangle, warning=FALSE}
####################### CCS
# Extract only values from mix of values and percentage 
CCS_values <- cbind(as.character(CCS[,1]), apply(CCS[,-1], 2, function(x) word(x, c(1), sep = fixed("(")))) 
colnames(CCS_values)[1] <- "Description"
CCS_values_mod <- as.data.frame(CCS_values) %>% melt(., id = "Description") %>% 
  # split CCS parameters 
  mutate(num_passes = word(variable, c(2), sep = fixed("_"))) %>% 
  mutate(RQ = word(variable, c(4), sep = fixed("_"))) %>%
  mutate(value = as.numeric(as.character(value)))
 
####################### LIMA
# Extract only values from the mix of values and percentage from LIMA output
LIMA_values <- data.frame(LIMA[,1],lapply(LIMA[,2:ncol(LIMA)], function(x) as.numeric(word(x, c(1),  sep = fixed ('(')) ))) 
colnames(LIMA_values)[1] <- "Description"
LIMA_values_mod <- as.data.frame(LIMA_values) %>% melt(., id = "Description") %>% 
  # split LIMA parameters 
  mutate(num_passes = word(variable, c(2), sep = fixed("_"))) %>% 
  mutate(RQ = word(variable, c(4), sep = fixed("_"))) %>% 
  mutate(RQ = as.character(paste0("0.", word(RQ, c(2), sep = fixed(".")))))


# Refine into one dataframe and data-wrangled for easy merging
REFINE <- do.call("rbind", REFINE_list) %>%
  rownames_to_column(., var = "variable") %>%
  mutate(num_passes = word(variable, c(2), sep = fixed("_"))) %>% 
  mutate(RQ = word(variable, c(4), sep = fixed("_"))) %>% 
  mutate(RQ = as.character(paste0("0.", word(RQ, c(2), sep = fixed("."))))) %>%
  as.data.frame() %>%
  gather(., Description, value, 2:4, factor_key=TRUE) %>%
  .[,c("Description","variable","value","num_passes","RQ")]


Reads <-   
  CCS_values_mod[CCS_values_mod$Description == "ZMWs generating CCS (B)  ",] %>%
  bind_rows(CCS_values_mod[CCS_values_mod$Description == "ZMWs input          (A)  ",]) %>%
  bind_rows(REFINE)

Reads$Description <- revalue(Reads$Description, c("ZMWs input          (A)  "="Polymerase Reads", "ZMWs generating CCS (B)  "="CCS Reads",
                             "num_reads_fl"="FL Reads", "num_reads_flnc"="FLNC reads",
                             "num_reads_flnc_polya" = "Poly-A FLNC reads"))
levels(Reads$Description) <- c("Polymerase Reads","CCS Reads","FL Reads","FLNC reads","Poly-A FLNC reads")


```
```{r create_plots, warning = FALSE}
### To calculate proportions to generate plots 
# total failed ccs reads 
failed_CCS_reads <- as.data.frame(CCS_values) %>% melt(., id = "Description") %>% filter(Description %in% c("ZMWs filtered       (C)  "))
failed_LIMA_reads <- as.data.frame(LIMA_values) %>% melt(., id = "Description") %>% filter(Description %in% c("ZMWs below any threshold  (C) "))


############# Applying plots

# p1: Percentage of polymerase reads successful for CCS generation
# p2: Rationale for failed polymerase reads for CCS generation
# P3: Percentage of CCS reads successful for FL generation 
# p4: Rationale for failed CCS reads for FL generation
# p5: Tally of all reads

p1 <- CCS_values_mod %>% 
  filter(Description %in% c("ZMWs input          (A)  ", "ZMWs generating CCS (B)  ")) %>%
  spread(., Description, value) %>% 
  mutate(Reads_Perc = .$"ZMWs generating CCS (B)  "  / .$"ZMWs input          (A)  " * 100 ) %>% 
  plot_line(., "num_passes", "Reads_Perc", "Number of Passes", "Passed polymerase reads (%)","RQ") +
  mytheme + theme(legend.position = "bottom") +
  scale_colour_manual(values = c(wes_palette("Chevalier1")[3], wes_palette("Darjeeling1")[2], wes_palette("Darjeeling1")[1],
                                 wes_palette("Darjeeling2")[5])) +
  scale_y_continuous(limits = c(70, 86))


p2 <- 
  CCS_values_mod %>% 
  filter(!Description %in% c("ZMWs input          (A)  ", "ZMWs generating CCS (B)  ", "ZMWs filtered       (C)  ")) %>%
  full_join(., failed_CCS_reads, by = "variable") %>%
  mutate(Perc = as.numeric(value.x)/as.numeric(value.y) * 100) %>%
  filter(as.numeric(value.x) != 0) %>% 
  ggplot(., aes(x = Perc, y = reorder(Description.x, Perc), fill = RQ)) + geom_bar(stat = "identity", position = position_dodge()) + 
  facet_grid(rows = vars(num_passes)) +
  mytheme + theme(legend.position = "bottom") + 
  labs(x = "Failed polymerase reads (%)", y = "Rationale") +
  scale_fill_manual(values = c(wes_palette("Chevalier1")[3], wes_palette("Darjeeling1")[2], wes_palette("Darjeeling1")[1], wes_palette("Darjeeling2")[5]))


p3 <- 
  LIMA_values_mod %>% 
  filter(Description %in% c("ZMWs input                (A) ", "ZMWs above all thresholds (B) ")) %>%
  spread(., Description, value) %>% 
  mutate(Reads_Perc = .$"ZMWs above all thresholds (B) "  / .$"ZMWs input                (A) " * 100 ) %>% 
  plot_line(., "num_passes", "Reads_Perc", "Number of Passes", "Passed CCS reads (%)","RQ") +
  mytheme + theme(legend.position = "bottom") +
  scale_colour_manual(values = c(wes_palette("Chevalier1")[3], wes_palette("Darjeeling1")[2], wes_palette("Darjeeling1")[1], wes_palette("Darjeeling2")[5])) 
  

p4 <-
  LIMA_values_mod %>% 
  filter(Description %in% c("Below min end score           ","Below min score               ",
                             "Below min length              ", "Below min passes              ",
                             "Below min ref span            ","Below min score lead          ",
                             "Without adapter               ","Undesired 3p--3p pairs        ",
                             "Undesired 5p--5p pairs        ","Undesired no hit              ")) %>%
  full_join(., failed_LIMA_reads, by = "variable") %>%
  mutate(Perc = as.numeric(value.x)/as.numeric(value.y) * 100) %>%
  filter(as.numeric(value.x) != 0) %>% 
  mutate(RQ = as.character(RQ)) %>%
  ggplot(., aes(x = Perc, y = reorder(Description.x, Perc), fill = RQ)) + geom_bar(stat = "identity", position = position_dodge()) + 
  facet_grid(rows = vars(num_passes)) +
  mytheme + theme(legend.position = "bottom") + 
  labs(x = "Failed CCS reads (%)", y = "Rationale") +
  scale_fill_manual(values = c(wes_palette("Chevalier1")[3], wes_palette("Darjeeling1")[2], wes_palette("Darjeeling1")[1], wes_palette("Darjeeling2")[5]))


p5 <- 
  Reads %>%
  ggplot(., aes(x = reorder(Description, -value), y = value, group = interaction(num_passes, RQ), colour = RQ, linetype = num_passes)) +
    geom_line() + 
    geom_point() +  
    mytheme + theme(legend.position = "bottom",axis.text.x = element_text(size=20)) + labs(x = "", y = "Number of Reads") +
    scale_colour_manual(values = c(wes_palette("Chevalier1")[3], wes_palette("Darjeeling1")[2], wes_palette("Darjeeling1")[1], wes_palette("Darjeeling2")[5]))

```

# Proporition of CCS generated 
Range of proporition of CCS generated can vary as much as 70% - 85%, with the main determining factor being RQ value particularly with only 1 full pass. 

```{r print_plots}
p1
```

The majority of polymerase reads failing to generate CCS is due to "lacking full passes" and "CCS below minimium RQ" (hence varying the two parameters). Of note, there are other reasons for failed CCS reads i.e. Draft generation error, Insufficient draft cov, Coverage drops, heteroduplex insertions. 

```{r print_plots}
p2
p3
p4
p5
```
```{r}

```
