---
title: "Post SMRTAnalysis"
output: html_document
---
AD mouse model, age: Tg4510, 2months (Baseline)
Phenotype: TG
Brain region: Entorinhal Cortex
Sample: O18
Objective: To tabulate the number of full-length reads obtained per gene from Isoseq and order genes from high to low, for comparison with RNAseq data for exact sample 

Rationale: To evaluate whether Isoseq output comparable to RNAseq output 

Analysis: 
1) Downloaded raw subread.bam file from Sequel output 
2) CCS and Isoseq3 command line (Lima, Cluster, Polish)
3) Mapped to mouse genome using GMAP 
4) Tofu Cupcake 
5) Sqanti for isoform characterisation  

```{r setup, include=FALSE}
# knitr::opts_knit$set(root.dir ="//isad.isadroot.ex.ac.uk/UOE/User/My Documents/PacBio/AD_Mouse_Tg4510/2 months/O18")
knitr::opts_knit$set(root.dir ="~")
```
Input: Sqanti Classification text with all details of HQ-unique isoforms filtered out
  Necessary as assigns PacBio output gene Cluster ID to mouse gene name 
Input: Cupcake of number of FL Reads (CCS) clustered for HQ-unique isoform  i.e. number of ZMW for each isoform
  Parameters: Minimum 2 FL-read reads per gene, and filtered by 5' degradation
  Therefore only tabulating the count ouput from TofuCupcake (Step 4)
```{r}
# O18_Classification <- read.delim2("//isad.isadroot.ex.ac.uk/UOE/User/My Documents/PacBio/AD_Mouse_Tg4510/2 months/O18/Isoseq3/O18_classification.txt", header = TRUE)
O18_Classification <- read.delim2("/mnt/data1/Szi/O18/Sqanti/O18_classification.txt", header = TRUE)

# Remove rows 1:14 of descriptor 
O18_Counts <- read.csv("/mnt/data1/Szi/O18/Collapse_Isoform_2/test.collapsed.min_fl_2.filtered.abundance.csv", header = TRUE)[-c(1:14),]

colnames(O18_Counts) <- c("PacBio_Id","count_fl","count_nfl","count_nfl_amb","norm_fl","norm_nfl","norm_nfl_amb")
```
```{r}
head(O18_Classification)
# to remove specific empty columns 
O18_Classification <- O18_Classification[,-which(names(O18_Classification) %in% c("sd_cov","min_cov","FL","min_sample_cov","iso_exp","gene_exp","ratio_exp"))]
```

```{r}
# To merge two files together by PacBio ID
O18_merge <- merge(O18_Classification,O18_Counts,by.x = "isoform", by.y = "PacBio_Id")
# write.csv(O18_merge,"//isad.isadroot.ex.ac.uk/UOE/User/My Documents/PacBio/AD_Mouse_Tg4510/2 months/O18/Isoseq3/Merged_O18.csv")
```

```{r}
# O18_merge <- read.csv("//isad.isadroot.ex.ac.uk/UOE/User/MyDocuments/PacBio/AD_Mouse_J20/O18/Merged_O18.csv", header = TRUE)[,-1]

# To include novel genes by replacing "-" with . and then extracting the first word 
# need to extract first word because associated gene has a number folowed by the . for the different isoforms, therefore associated gene not recognised by biomart  
library(stringr)
O18_merge$associated_gene <- str_replace_all(O18_merge$associated_gene,"_",".")

# to extract the first number separated by . per row (carried out with a for loop)
strings <- data.frame()
for(row in 1:nrow(O18_merge)){
  gene <- O18_merge$associated_gene[row]
  df <- word(gene,1, sep = fixed ('.'))
  strings[row,1] <- df
}
O18_ordered <- cbind(O18_merge,strings)

```

```{r}
# Convert Ensembl ID to gene using biomart
library("biomaRt")
# mart = mouse genome
mart <- useDataset("mmusculus_gene_ensembl", useMart("ensembl"))
# genes = V1 input 
genes <- O18_ordered$V1
G_list <- getBM(filters= "ensembl_gene_id", attributes=
                  c("ensembl_gene_id","mgi_symbol"),values=genes,mart= mart)

O18_ordered <- merge(O18_ordered,G_list,by.x = "V1", by.y = "ensembl_gene_id",all = TRUE)
O18_ordered_unique <- unique(O18_ordered)
# to rearrange columns for formatting; column 34 = final column = mgi_symbol 
# column 2:33 of all columns -1 (V1 from stringi, extracted name)
O18_ordered_unique <- O18_ordered_unique[,c(34,2:33)]

# order FL from highest to lowest
O18_ordered_unique$count_fl <- as.numeric(as.character(O18_ordered_unique$count_fl))
O18_ordered_unique <- O18_ordered_unique[order(-O18_ordered_unique$count_fl),]

# save output 
dir.create(/mnt/data1/Szi/O18/Comparisons_RNAseq)
write.csv(O18_ordered_unique,"/mnt/data1/Szi/O18/Comparisons_RNAseq/O18_ordered_unique.csv")

```

